import streamlit as st
import google.generativeai as genai
import sqlite3
import pandas as pd
import datetime
import time
import json
import re

# --- 1. è¨­å®šèˆ‡ API Key (å¾Œç«¯å¯«æ­») ---
GEMINI_API_KEY = "AIzaSyBXOxRg0KY8RsWoUrj25mZpLDgtk21luW4"

# è¨­å®šé é¢è³‡è¨Š (å¿…é ˆæ˜¯ç¬¬ä¸€å€‹ st æŒ‡ä»¤)
st.set_page_config(page_title="å¨æ°èƒ½æºå…§éƒ¨é»é¤ç³»çµ±", layout="wide")

# è¨­å®š Gemini
try:
    genai.configure(api_key=GEMINI_API_KEY)
except Exception as e:
    st.error(f"API Key è¨­å®šå¤±æ•—: {e}")

# --- 2. CSS æ¨£å¼æ³¨å…¥ (é»‘ç™½æ¥µç°¡é¢¨æ ¼ + è¼¸å…¥æ¡†ä¿®æ­£) ---
def inject_custom_css():
    st.markdown("""
    <style>
        /* å…¨åŸŸèƒŒæ™¯ */
        .stApp {
            background-color: #FFFFFF;
            color: #000000;
        }
        
        /* å´é‚Šæ¬„æ¨£å¼ */
        [data-testid="stSidebar"] {
            background-color: #000000;
        }
        [data-testid="stSidebar"] * {
            color: #FFFFFF !important;
        }
        
        /* è¼¸å…¥æ¡†å¼·åˆ¶é»‘åº•ç™½å­— */
        .stTextInput input, .stNumberInput input, .stSelectbox div[data-baseweb="select"] > div {
            background-color: #000000 !important;
            color: #FFFFFF !important;
            caret-color: #FFFFFF; /* æ¸¸æ¨™é¡è‰² */
            border: 1px solid #666;
        }
        
        /* ä¸‹æ‹‰é¸å–®çš„é¸é …æ¸…å–® (Dropdown options) */
        ul[data-testid="stSelectboxVirtualDropdown"] {
            background-color: #000000 !important;
        }
        li[role="option"] {
            color: #FFFFFF !important;
        }
        
        /* æŒ‰éˆ•æ¨£å¼ (é»‘åº•ç™½å­—) */
        .stButton > button {
            background-color: #000000 !important;
            color: #FFFFFF !important;
            border: 1px solid #000000;
            font-weight: bold;
        }
        .stButton > button:hover {
            border-color: #666666;
            color: #cccccc !important;
        }

        /* æ¨™é¡Œé¡è‰² */
        h1, h2, h3, h4, h5, h6 {
            color: #000000 !important;
        }
        
        /* Metric æŒ‡æ¨™å¡å„ªåŒ– */
        [data-testid="stMetricValue"] {
            color: #000000 !important;
        }
        [data-testid="stMetricLabel"] {
            color: #333333 !important;
        }
    </style>
    """, unsafe_allow_html=True)

inject_custom_css()

# --- 3. è³‡æ–™åº«èˆ‡è¼”åŠ©å‡½å¼ ---
DB_NAME = "ordering_system.db"

def get_db_connection():
    conn = sqlite3.connect(DB_NAME)
    conn.row_factory = sqlite3.Row
    return conn

def init_db():
    """åˆå§‹åŒ–è³‡æ–™åº«èˆ‡è³‡æ–™è¡¨"""
    with get_db_connection() as conn:
        cursor = conn.cursor()
        
        # Users Table
        cursor.execute('''
            CREATE TABLE IF NOT EXISTS Users (
                user_id INTEGER PRIMARY KEY AUTOINCREMENT,
                name TEXT UNIQUE NOT NULL,
                current_balance INTEGER DEFAULT 0
            )
        ''')
        
        # Menu Table
        cursor.execute('''
            CREATE TABLE IF NOT EXISTS Menu (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                date TEXT NOT NULL,
                dish_name TEXT NOT NULL,
                price INTEGER NOT NULL
            )
        ''')
        
        # Transactions Table
        cursor.execute('''
            CREATE TABLE IF NOT EXISTS Transactions (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                user_id INTEGER,
                type TEXT NOT NULL, -- 'ORDER', 'TOPUP', 'INIT'
                amount INTEGER NOT NULL,
                dish_name TEXT,
                note TEXT,
                timestamp DATETIME DEFAULT CURRENT_TIMESTAMP,
                FOREIGN KEY (user_id) REFERENCES Users (user_id)
            )
        ''')
        conn.commit()

# åˆå§‹åŒ– DB
init_db()

# --- 4. å´é‚Šæ¬„å°èˆª ---
st.sidebar.title("å¨æ°èƒ½æºé»é¤ç³»çµ±")
page = st.sidebar.radio(
    "åŠŸèƒ½é¸å–®",
    ["ğŸ½ï¸ å“¡å·¥é»é¤", "ğŸ¤– èœå–®ç®¡ç† (AI)", "ğŸ’° å„²å€¼ä½œæ¥­", "ğŸ“Š æ¯æ—¥é»é¤åŒ¯ç¸½", "ğŸ‘¥ äººå“¡ç®¡ç†"]
)

# --- 5. é é¢é‚è¼¯ ---

# === é é¢ 1: å“¡å·¥é»é¤ ===
if page == "ğŸ½ï¸ å“¡å·¥é»é¤":
    st.title("ğŸ½ï¸ æ­¡è¿é»é¤")
    
    # 1. é¸æ“‡å“¡å·¥
    with get_db_connection() as conn:
        users = pd.read_sql("SELECT user_id, name, current_balance FROM Users", conn)
    
    if users.empty:
        st.warning("ç›®å‰æ²’æœ‰å“¡å·¥è³‡æ–™ï¼Œè«‹è¯ç¹«ç®¡ç†å“¡æ–°å¢ã€‚")
    else:
        user_names = users['name'].tolist()
        selected_user_name = st.selectbox("è«‹é¸æ“‡æ‚¨çš„å§“å", user_names)
        
        # å–å¾—é¸å®šå“¡å·¥çš„è©³ç´°è³‡æ–™
        current_user = users[users['name'] == selected_user_name].iloc[0]
        user_id = int(current_user['user_id'])
        balance = int(current_user['current_balance'])
        
        # é¡¯ç¤ºé¤˜é¡ (å¤§å­—é«”)
        st.metric("ç›®å‰é¤˜é¡", f"${balance}")
        
        st.divider()

        # 2. æ­·å²æ¶ˆè²»ç´€éŒ„ (æœ¬æœˆ)
        st.subheader("ğŸ“… æœ¬æœˆæ¶ˆè²»ç´€éŒ„")
        with get_db_connection() as conn:
            # å–å¾—æœ¬æœˆç¬¬ä¸€å¤©
            first_day = datetime.date.today().replace(day=1).strftime('%Y-%m-%d')
            query = """
                SELECT strftime('%Y-%m-%d %H:%M', timestamp) as æ™‚é–“,
                       dish_name as é …ç›®,
                       amount as é‡‘é¡,
                       note as å‚™è¨»
                FROM Transactions 
                WHERE user_id = ? AND timestamp >= ? 
                ORDER BY timestamp DESC
            """
            history_df = pd.read_sql(query, conn, params=(user_id, first_day))
        
        st.dataframe(history_df, use_container_width=True, hide_index=True)

        st.divider()
        
        # 3. ä»Šæ—¥èœå–®èˆ‡é»é¤å¡ç‰‡
        st.subheader("ğŸ± ä»Šæ—¥èœå–®")
        today = datetime.date.today().strftime("%Y-%m-%d")
        
        with get_db_connection() as conn:
            menu_df = pd.read_sql("SELECT * FROM Menu WHERE date = ?", conn, params=(today,))
            
        if menu_df.empty:
            st.info("ä»Šæ—¥å°šæœªç™¼å¸ƒèœå–®ã€‚")
        else:
            # å®šç¾©ç¢ºèªè¦–çª— (ä½¿ç”¨ st.dialog - Streamlit 1.34+)
            @st.dialog("ç¢ºèªé»é¤è³‡è¨Š")
            def confirm_order(dish_name, price, note, user_id, user_name):
                st.write(f"**å“¡å·¥:** {user_name}")
                st.write(f"**é¤é»:** {dish_name}")
                st.write(f"**åƒ¹æ ¼:** ${price}")
                st.write(f"**å‚™è¨»:** {note if note else 'ç„¡'}")
                st.warning("é»æ“Šç¢ºèªå¾Œå°‡ç›´æ¥æ‰£æ¬¾ã€‚")
                
                col1, col2 = st.columns(2)
                if col1.button("âœ… ç¢ºèªé»é¤"):
                    try:
                        with get_db_connection() as conn:
                            cursor = conn.cursor()
                            # æ‰£æ¬¾äº¤æ˜“
                            cursor.execute("""
                                INSERT INTO Transactions (user_id, type, amount, dish_name, note)
                                VALUES (?, 'ORDER', ?, ?, ?)
                            """, (user_id, -price, dish_name, note))
                            
                            # æ›´æ–°é¤˜é¡
                            cursor.execute("""
                                UPDATE Users SET current_balance = current_balance - ?
                                WHERE user_id = ?
                            """, (price, user_id))
                            conn.commit()
                        
                        st.success("é»é¤æˆåŠŸï¼")
                        time.sleep(1)
                        st.rerun()
                    except Exception as e:
                        st.error(f"é»é¤å¤±æ•—: {e}")
                
                if col2.button("âŒ å–æ¶ˆ"):
                    st.rerun()

            # é¡¯ç¤ºå¡ç‰‡ Grid
            cols = st.columns(4)
            for idx, row in menu_df.iterrows():
                with cols[idx % 4]:
                    with st.container(border=True):
                        st.write(f"**{row['dish_name']}**")
                        st.markdown(f"<h3>${row['price']}</h3>", unsafe_allow_html=True)
                        
                        # å‚™è¨»è¼¸å…¥æ¡† (å”¯ä¸€çš„ key é¿å…è¡çª)
                        note = st.text_input("å‚™è¨» (å¦‚:é£¯å°‘)", key=f"note_{row['id']}")
                        
                        if st.button("é¸è³¼", key=f"btn_{row['id']}"):
                            confirm_order(row['dish_name'], row['price'], note, user_id, selected_user_name)

# === é é¢ 2: èœå–®ç®¡ç† (AI) ===
elif page == "ğŸ¤– èœå–®ç®¡ç† (AI)":
    st.title("ğŸ¤– æ™ºèƒ½èœå–®ç®¡ç†")
    
    # æª”æ¡ˆä¸Šå‚³
    uploaded_file = st.file_uploader("ä¸Šå‚³èœå–®åœ–ç‰‡ (JPG/PNG)", type=["jpg", "jpeg", "png"])
    
    # ä½¿ç”¨ session_state ç®¡ç†ç‹€æ…‹
    if 'menu_df' not in st.session_state:
        st.session_state['menu_df'] = None

    if uploaded_file:
        # å¦‚æœé‚„æ²’è¾¨è­˜éï¼Œå°±å‘¼å« AI
        if st.session_state['menu_df'] is None:
            with st.spinner("AI æ­£åœ¨è¾¨è­˜èœå–®ä¸­ï¼Œè«‹ç¨å€™..."):
                try:
                    image_parts = [{"mime_type": uploaded_file.type, "data": uploaded_file.getvalue()}]
                    model = genai.GenerativeModel('gemini-1.5-flash')
                    prompt = """
                    Analyze this menu image. Extract dish names and prices.
                    Return ONLY a raw JSON list like [{"dish_name": "name", "price": 100}].
                    Do not use Markdown formatting or code blocks. Just the JSON string.
                    """
                    response = model.generate_content([prompt, image_parts[0]])
                    text = response.text.strip()
                    # æ¸…ç†å¯èƒ½çš„å›å‚³æ ¼å¼
                    text = text.replace("```json", "").replace("```", "")
                    
                    data = json.loads(text)
                    st.session_state['menu_df'] = pd.DataFrame(data)
                except Exception as e:
                    st.error(f"è¾¨è­˜å¤±æ•—: {e}")
        
        # é¡¯ç¤ºç·¨è¼¯å™¨
        if st.session_state['menu_df'] is not None:
            st.subheader("ç·¨è¼¯èˆ‡ç¢ºèª")
            edited_df = st.data_editor(st.session_state['menu_df'], num_rows="dynamic")
            
            if st.button("ç¢ºèªç™¼å¸ƒä»Šæ—¥èœå–®"):
                try:
                    today = datetime.date.today().strftime("%Y-%m-%d")
                    with get_db_connection() as conn:
                        cursor = conn.cursor()
                        # æ¸…é™¤ä»Šæ—¥èˆŠèœå–® (è‹¥æœ‰çš„è©±)
                        cursor.execute("DELETE FROM Menu WHERE date = ?", (today,))
                        
                        # å¯«å…¥æ–°èœå–®
                        for _, row in edited_df.iterrows():
                            cursor.execute(
                                "INSERT INTO Menu (date, dish_name, price) VALUES (?, ?, ?)",
                                (today, row['dish_name'], row['price'])
                            )
                        conn.commit()
                    
                    st.success("èœå–®å·²æˆåŠŸç™¼å¸ƒï¼")
                    # æ¸…é™¤ç‹€æ…‹
                    st.session_state['menu_df'] = None
                    time.sleep(1.5)
                    st.rerun()
                except Exception as e:
                    st.error(f"å¯«å…¥è³‡æ–™åº«å¤±æ•—: {e}")

# === é é¢ 3: å„²å€¼ä½œæ¥­ ===
elif page == "ğŸ’° å„²å€¼ä½œæ¥­":
    st.title("ğŸ’° å“¡å·¥å„²å€¼ä½œæ¥­")
    
    with get_db_connection() as conn:
        users = pd.read_sql("SELECT user_id, name, current_balance FROM Users", conn)
    
    if users.empty:
        st.warning("ç„¡å“¡å·¥è³‡æ–™")
    else:
        # ä½¿ç”¨ Form è§£æ±ºæŒ‰éˆ•å¤±æ•ˆå•é¡Œ
        with st.form("topup_form"):
            col1, col2 = st.columns(2)
            with col1:
                user_name_options = users['name'].tolist()
                selected_name = st.selectbox("é¸æ“‡å“¡å·¥", user_name_options)
            with col2:
                amount = st.number_input("å„²å€¼é‡‘é¡", min_value=1, step=100)
            
            submitted = st.form_submit_button("ç¢ºèªå„²å€¼")
            
            if submitted:
                target_user = users[users['name'] == selected_name].iloc[0]
                user_id = int(target_user['user_id'])
                
                try:
                    with get_db_connection() as conn:
                        cursor = conn.cursor()
                        # æ–°å¢äº¤æ˜“ç´€éŒ„
                        cursor.execute("""
                            INSERT INTO Transactions (user_id, type, amount, note)
                            VALUES (?, 'TOPUP', ?, 'ç®¡ç†å“¡å„²å€¼')
                        """, (user_id, amount))
                        
                        # æ›´æ–°é¤˜é¡
                        cursor.execute("""
                            UPDATE Users SET current_balance = current_balance + ?
                            WHERE user_id = ?
                        """, (amount, user_id))
                        conn.commit()
                        
                    st.success(f"å·²æˆåŠŸç‚º {selected_name} å„²å€¼ ${amount}")
                    time.sleep(1)
                    st.rerun()
                except Exception as e:
                    st.error(f"å„²å€¼å¤±æ•—: {e}")

# === é é¢ 4: æ¯æ—¥é»é¤åŒ¯ç¸½ ===
elif page == "ğŸ“Š æ¯æ—¥é»é¤åŒ¯ç¸½":
    st.title("ğŸ“Š æ¯æ—¥é»é¤åŒ¯ç¸½")
    today_str = datetime.date.today().strftime("%Y-%m-%d")
    st.write(f"**æ—¥æœŸ:** {today_str}")
    
    with get_db_connection() as conn:
        # è¨ˆç®—æŒ‡æ¨™
        # 1. åˆå§‹å„²å€¼é‡‘ç¸½é¡ (ç›®å‰æ‰€æœ‰äººçš„é¤˜é¡ç¸½å’Œ)
        total_balance = conn.execute("SELECT SUM(current_balance) FROM Users").fetchone()[0] or 0
        
        # 2. ä»Šæ—¥å„²å€¼ç¸½é¡
        today_topup = conn.execute(
            "SELECT SUM(amount) FROM Transactions WHERE type='TOPUP' AND date(timestamp) = ?", 
            (today_str,)
        ).fetchone()[0] or 0
        
        # 3. ä»Šæ—¥è¨‚å–®ç¸½é¡ (Amount æ˜¯è² çš„ï¼Œæ‰€ä»¥åŠ è² è™Ÿè½‰æ­£)
        today_order_sum = conn.execute(
            "SELECT SUM(amount) FROM Transactions WHERE type='ORDER' AND date(timestamp) = ?", 
            (today_str,)
        ).fetchone()[0] or 0
        today_order_total = abs(today_order_sum)
        
        # é¡¯ç¤ºæŒ‡æ¨™å¡
        m1, m2, m3 = st.columns(3)
        m1.metric("åˆå§‹å„²å€¼é‡‘ç¸½é¡ (ç›®å‰ç¸½é¤˜é¡)", f"${total_balance}")
        m2.metric("ä»Šæ—¥å„²å€¼é‡‘ç¸½é¡", f"${today_topup}")
        m3.metric("ä»Šæ—¥è¨‚å–®ç¸½é¡", f"${today_order_total}")
        
        st.divider()
        st.subheader("ğŸ“‹ ä»Šæ—¥è¨‚å–®æ˜ç´°")
        
        # æŸ¥è©¢è©³ç´°å ±è¡¨
        query = """
            SELECT 
                time(t.timestamp) as æ™‚é–“,
                u.name as å“¡å·¥å§“å,
                t.dish_name as é¤é»åç¨±,
                t.note as å‚™è¨»,
                ABS(t.amount) as åƒ¹æ ¼
            FROM Transactions t
            JOIN Users u ON t.user_id = u.user_id
            WHERE t.type = 'ORDER' AND date(t.timestamp) = ?
            ORDER BY t.timestamp DESC
        """
        report_df = pd.read_sql(query, conn, params=(today_str,))
        
        if report_df.empty:
            st.info("ä»Šæ—¥å°šç„¡è¨‚å–®")
        else:
            st.dataframe(report_df, use_container_width=True)

# === é é¢ 5: äººå“¡ç®¡ç† ===
elif page == "ğŸ‘¥ äººå“¡ç®¡ç†":
    st.title("ğŸ‘¥ äººå“¡ç®¡ç†")
    
    # æ–°å¢å“¡å·¥ Form
    with st.expander("â• æ–°å¢å“¡å·¥", expanded=True):
        with st.form("add_user_form"):
            new_name = st.text_input("å“¡å·¥å§“å")
            initial_balance = st.number_input("åˆå§‹é‡‘é¡", min_value=0, value=0)
            submit_add = st.form_submit_button("æ–°å¢")
            
            if submit_add:
                if new_name:
                    try:
                        with get_db_connection() as conn:
                            cursor = conn.cursor()
                            cursor.execute("INSERT INTO Users (name, current_balance) VALUES (?, ?)", (new_name, initial_balance))
                            # å–å¾—å‰›æ’å…¥çš„ ID
                            new_id = cursor.lastrowid
                            # å¯«å…¥åˆå§‹äº¤æ˜“
                            cursor.execute("""
                                INSERT INTO Transactions (user_id, type, amount, note)
                                VALUES (?, 'INIT', ?, 'åˆå§‹é–‹æˆ¶')
                            """, (new_id, initial_balance))
                            conn.commit()
                        st.success(f"å“¡å·¥ {new_name} æ–°å¢æˆåŠŸï¼")
                        time.sleep(1)
                        st.rerun()
                    except sqlite3.IntegrityError:
                        st.error("è©²å“¡å·¥å§“åå·²å­˜åœ¨ï¼")
                    except Exception as e:
                        st.error(f"éŒ¯èª¤: {e}")
                else:
                    st.warning("è«‹è¼¸å…¥å§“å")

    st.divider()
    
    # å“¡å·¥åˆ—è¡¨èˆ‡åˆªé™¤
    st.subheader("ç¾æœ‰å“¡å·¥æ¸…å–®")
    with get_db_connection() as conn:
        users = pd.read_sql("SELECT * FROM Users", conn)
    
    st.dataframe(users, use_container_width=True)
    
    st.divider()
    
    # åˆªé™¤å€å¡Š
    st.subheader("ğŸš« åˆªé™¤/åœç”¨å“¡å·¥")
    user_to_delete = st.selectbox("é¸æ“‡è¦åˆªé™¤çš„å“¡å·¥", users['name'].tolist() if not users.empty else [])
    
    if st.button("ç¢ºèªåˆªé™¤æ­¤å“¡å·¥"):
        if user_to_delete:
            try:
                with get_db_connection() as conn:
                    cursor = conn.cursor()
                    cursor.execute("DELETE FROM Users WHERE name = ?", (user_to_delete,))
                    conn.commit()
                st.warning(f"å“¡å·¥ {user_to_delete} å·²åˆªé™¤")
                time.sleep(1)
                st.rerun()
            except Exception as e:
                st.error(f"åˆªé™¤å¤±æ•—: {e}")